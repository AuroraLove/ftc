<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.auroralove.ftctoken.mapper.DealMapper">
    <sql id="USER">ftc_user</sql>
    <sql id="DEAL">ftc_deal</sql>
    <insert id="newDealRecord" parameterType="com.auroralove.ftctoken.model.DealModel">
        INSERT INTO
        <include refid="DEAL"/>
        (
        tid,
        uid,
        univalent,
        quantity,
        deal_amount,
        deal_date,
        type,
        status,
        phone,
        user_name
        )
        VALUES
        (
        #{tid},
        #{uid},
        #{univalent},
        #{quantity},
        #{deal_amount},
        NOW(),
        #{type},
        #{status},
        #{phone},
        #{user_name}
        )
    </insert>

    <select id="getPurchaseDeals" resultType="com.auroralove.ftctoken.model.DealModel">
     SELECT tid,uid,phone,univalent,quantity,deal_amount,deal_date,status,type from ftc_deal where uid in
(select t1.uid from
(select uid,sum(deal_amount) as buy_release_amount from ftc_deal  where type in(0,7) and status=6 GROUP BY uid) as t1 left   join
 (select uid,sum(deal_amount) as sell_amount from ftc_deal  where type=1 and status=6 GROUP BY uid)  as t2 ON t1.uid = t2.uid order by
 (t1.buy_release_amount- t2.sell_amount) desc) and type = 0 and status = 3
    </select>


    <select id="getSellDeals" resultType="com.auroralove.ftctoken.model.DealModel">
    SELECT tid,uid,phone,univalent,quantity,deal_amount,deal_date,status,type from ftc_deal where type = 1 and status = 3 ORDER BY deal_date
    </select>

    <insert id="newOrder" parameterType="com.auroralove.ftctoken.model.OrderModel" >
        INSERT INTO ftc_order
        (
        oid,
        deal_buy_id,
        deal_sell_id,
        seller_id,
        buyer_id,
        seller_phone,
        seller_name,
        buyer_phone,
        buyer_name,
        oder_date,
        status,
        univalent,
        quantity,
        deal_amount
        )
        VALUES
          (
            #{oid},
            #{deal_buy_id},
            #{deal_sell_id},
            #{seller_id},
            #{buyer_id},
            #{seller_phone},
            #{buyer_phone},
            NOW(),
            #{status},
            #{univalent},
            #{quantity},
            #{deal_amount}
           )
    </insert>

    <select id="getOrder" resultType="com.auroralove.ftctoken.model.OrderModel">
    SELECT (
        oid,
        deal_buy_id,
        deal_sell_id,
        seller_id,
        buyer_id,
        seller_phone,
        buyer_phone,
        oder_date,
        status,
        univalent,
        quantity,
        deal_amount,
        pay_way,
        affirm_date,
        order_date,
        finnish_date
    ) from ftc_order where oid = #{oid}
    </select>

    <select id="getCommutableAssets" resultMap="commutableAssests">
    SELECT uid ,deal_amount,deal_date ,status
    from ftc_deal where uid = #{id} and type in (0,1,7)
    </select>

    <select id="getRewardRecord" resultType="com.auroralove.ftctoken.model.RecordModel" >
    SELECT rid,uid,child_id as childId,child_phone as childPhone,level,amount,reward_date as rewardDate
    from ftc_reward where uid = #{id}
    </select>

    <update id="updateOrder" parameterType="com.auroralove.ftctoken.model.OrderModel">
        update ftc_order
        <set>
          <if test="status==5">
              status = #{status},
              pay_way = #{pay_way},
              pay_date = NOW(),
          </if>
            <if test="status==6">
                status = #{status},
                affirm_date = NOW(),
            </if>
        </set>
    </update>
    <resultMap type="com.auroralove.ftctoken.entity.AssetEntity" id="commutableAssests">
        <result column="uid" property="id"/>
        <result column="deal_amount" property="tradingAmount"/>
        <result column="deal_date" property="tadingDate"/>
        <result column="status" property="tradingStatus"/>
    </resultMap>
    <resultMap type="com.auroralove.ftctoken.model.OrderModel" id="OrderModel">
        <result column="oid" property="orderId"/>
        <result column="deal_buy_id" property="dealBuyId"/>
        <result column="deal_sell_id" property="dealSellId"/>
        <result column="seller_id" property="sellerId"/>
        <result column="buyer_id" property="buyerId"/>
        <result column="seller_phone" property="sellerPhone"/>
        <result column="buyer_phone" property="buyerPhone"/>
        <result column="oder_date" property="orderTime"/>
        <result column="status" property="orderStatus"/>
        <result column="univalent" property="univalent"/>
        <result column="quantity" property="quantity"/>
        <result column="deal_amount" property="amount"/>
        <result column="affirm_date" property="affirmDate"/>
        <result column="put_money_date" property="putMoneyDate"/>
        <result column="finnish_date" property="finnishDate"/>
    </resultMap>

</mapper>